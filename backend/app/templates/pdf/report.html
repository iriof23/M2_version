<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ report.title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. DESIGN TOKENS --- */
        :root {
            --primary: {{ client.primary_color | default('#10b981') }};
            --primary-dim: {{ client.primary_color | default('#10b981') }}20;
            --dark: #09090b;
            --slate: #475569;
            --border: #e2e8f0;
            
            /* Severity Colors */
            --sev-critical: #be123c; --sev-critical-bg: #fff1f2;
            --sev-high: #c2410c;     --sev-high-bg: #fff7ed;
            --sev-medium: #eab308;   --sev-medium-bg: #fefce8;
            --sev-low: #10b981;      --sev-low-bg: #ecfdf5;
            --sev-info: #3b82f6;     --sev-info-bg: #eff6ff;
        }

        /* --- 2. THE NUCLEAR PAGE LOGIC (THIS FIXES THE BORDERS) --- */
        
        /* Rule A: Default margins for Page 2, 3, 4... (The Text Pages) */
        @page {
            size: A4;
            margin-top: 35mm;    /* Room for Header */
            margin-bottom: 25mm; /* Room for Footer */
            margin-left: 20mm;
            margin-right: 20mm;
        }

        /* Rule B: THE OVERRIDE. Page 1 has ZERO margins. Full Sheet. */
        @page :first {
            margin: 0 !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            font-size: 10pt;
            line-height: 1.5;
            color: #1e293b;
            margin: 0;
            background: #fff;
            -webkit-print-color-adjust: exact;
        }

        /* --- 3. RUNNING HEADER (Hidden on Page 1 automatically by @page :first logic in some renderers, but we force z-index to be safe) --- */
        .running-header {
            position: fixed;
            top: -20mm; /* Moves into the margin area of Page 2+ */
            left: 0; right: 0; height: 15mm;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--primary);
            background: #fff;
            z-index: 100;
        }

        .header-logo { font-weight: 800; color: var(--dark); font-size: 11pt; display: flex; align-items: center; }
        .header-meta { font-family: 'JetBrains Mono'; font-size: 8pt; color: var(--slate); text-transform: uppercase; letter-spacing: 1px; }

        /* --- 4. COVER PAGE (FULL SHEET, NO NEGATIVE MARGINS NEEDED) --- */
        .cover-page {
            /* Since @page :first has 0 margin, this div will naturally hit the edges */
            width: 210mm;
            height: 297mm; /* Exact A4 Height */
            
            /* Background & Texture */
            background-color: var(--dark);
            color: white;
            display: flex; flex-direction: column; justify-content: space-between;
            background-image: 
                radial-gradient(circle at 100% 0%, var(--primary-dim) 0%, transparent 40%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            
            /* Ensure it sits on top of everything else on Page 1 */
            position: relative;
            z-index: 9999;
            page-break-after: always;
        }

        .cover-border {
            position: absolute; left: 0; top: 0; bottom: 0; width: 8px;
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary-dim);
        }

        /* Adjusted Padding for Cover Internal Content */
        .cover-content { padding: 0 25mm; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }

        .report-pill {
            font-family: 'JetBrains Mono', monospace; font-size: 9pt; color: var(--primary);
            border: 1px solid var(--primary-dim); background: rgba(255,255,255,0.03);
            padding: 6px 14px; border-radius: 100px; display: inline-block; margin-bottom: 25px;
            text-transform: uppercase; letter-spacing: 2px;
        }

        h1.display {
            font-size: 32pt; /* Reduced size as requested */
            font-weight: 700; line-height: 1.2; letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- 5. SYMMETRIC FOOTER (Distributed) --- */
        .cover-footer {
            padding: 15mm 25mm;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 Equal Columns */
            gap: 20px;
            align-items: center;
        }
        
        .footer-col-left { text-align: left; }
        .footer-col-center { text-align: center; }
        .footer-col-right { text-align: right; }

        .meta-label { font-family: 'JetBrains Mono'; font-size: 7pt; text-transform: uppercase; color: #64748b; display: block; margin-bottom: 5px; }
        .meta-val { font-size: 10pt; font-weight: 600; color: white; }

        /* --- 6. INTERNAL CONTENT --- */
        /* Note: No wrapper needed for margins anymore, @page handles it */
        .content-wrapper { width: 100%; }

        .summary-dashboard {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 25px; margin-bottom: 40px;
            display: flex; align-items: center; gap: 40px;
        }
        
        .total-circle {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--primary);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: white;
        }
        .total-num { font-size: 20pt; font-weight: 800; color: var(--dark); line-height: 1; }
        
        .risk-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .risk-tile { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; }
        .risk-num { font-size: 16pt; font-weight: 800; display: block; margin-bottom: 2px; }
        .risk-lbl { font-size: 7pt; text-transform: uppercase; font-weight: 700; color: var(--slate); }
        .risk-bar { height: 6px; width: 100%; display: flex; border-radius: 3px; overflow: hidden; margin-top: 15px; }

        /* Finding Cards */
        .finding-card {
            border: 1px solid var(--border); margin-bottom: 30px;
            page-break-inside: avoid; background: #fff; border-radius: 6px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
        }
        .finding-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .header-CRITICAL { background: var(--sev-critical); }
        .header-HIGH { background: var(--sev-high); }
        .header-MEDIUM { background: var(--sev-medium); }
        .header-LOW { background: var(--sev-low); }
        .header-INFO { background: var(--sev-info); }

        .finding-title { font-size: 12pt; font-weight: 700; }
        .card-body { padding: 20px 25px; }
        .field-label {
            font-family: 'JetBrains Mono'; font-size: 8pt; font-weight: 700; text-transform: uppercase; color: var(--slate); 
            margin-bottom: 8px; margin-top: 20px; letter-spacing: 0.5px; display: block;
        }
        .field-label:first-child { margin-top: 0; }

        .evidence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .evidence-item { border: 1px solid var(--border); background: #f8fafc; padding: 5px; }
        .evidence-item img { width: 100%; display: block; }
        .evidence-caption { padding: 6px; font-size: 8pt; color: var(--slate); font-family: 'JetBrains Mono'; text-align: center; }

        /* FOOTER (Fixed in Margin for Page 2+) */
        .page-footer {
            position: fixed;
            bottom: -15mm; /* Moves footer into margin */
            left: 0; right: 0;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 7pt; color: var(--slate); text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        h2.section-title {
            font-size: 14pt; text-transform: uppercase; letter-spacing: 0.05em; color: var(--dark); 
            border-bottom: 2px solid var(--dark); padding-bottom: 10px; margin-bottom: 30px; 
        }
        .page-break { page-break-after: always; }
        .markdown-body { font-size: 10pt; color: #334155; }
        .markdown-body pre { background: #f1f5f9; padding: 12px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 9pt; border: 1px solid var(--border); white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="running-header">
        <div class="header-logo">
            {% if client.logo %}
                <img src="{{ client.logo }}" style="height: 25px; margin-right: 10px;">
            {% endif %}
            <span>{{ client.name }}</span>
        </div>
        <div class="header-meta">{{ report.title }}</div>
    </div>

    <div class="cover-page">
        <div class="cover-border"></div>
        
        <div style="padding: 20mm 25mm 0 25mm;">
            {% if client.logo %}
                <img src="{{ client.logo }}" style="height: 45px; filter: brightness(0) invert(1);">
            {% else %}
                <h3 style="font-size: 20pt; margin: 0;">{{ client.name }}</h3>
            {% endif %}
        </div>

        <div class="cover-content">
            <div>
                <span class="report-pill">CONFIDENTIAL</span>
                <h1 class="display">{{ report.title }}</h1>
            </div>
        </div>

        <div class="cover-footer">
            <div class="footer-col-left">
                <span class="meta-label">Prepared For</span>
                <span class="meta-val">{{ client.name }}</span>
            </div>
            <div class="footer-col-center">
                <span class="meta-label">Date</span>
                <span class="meta-val">{{ report.date }}</span>
            </div>
            <div class="footer-col-right">
                <span class="meta-label">Reference ID</span>
                <span class="meta-val" style="font-family: 'JetBrains Mono'">{{ report.id[:8] }}</span>
            </div>
        </div>
    </div>

    <div class="content-wrapper page-break">
        <h2 class="section-title" style="border: none; margin-bottom: 30px; font-size: 20pt;">Table of Contents</h2>
        <div style="border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-weight: 600;">
                <span>1. Executive Summary</span> <span style="font-family: 'JetBrains Mono'">03</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-weight: 600;">
                <span>2. Technical Findings</span> <span style="font-family: 'JetBrains Mono'">04</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-weight: 600;">
                <span>3. Conclusion</span> <span style="font-family: 'JetBrains Mono'">End</span>
            </div>
        </div>
    </div>

    <div class="content-wrapper page-break">
        <h2 class="section-title">1. Executive Summary</h2>
        <div class="summary-dashboard">
            <div class="total-circle">
                <span class="total-num">{{ findings|length }}</span>
                <span style="font-size: 7pt; font-weight: 700; color: #64748b; text-transform: uppercase;">Issues</span>
            </div>
            <div style="flex-grow: 1;">
                <div class="risk-grid">
                    <div class="risk-tile">
                        <span class="risk-num" style="color: var(--sev-critical)">{{ stats.critical }}</span>
                        <span class="risk-lbl">Critical</span>
                    </div>
                    <div class="risk-tile">
                        <span class="risk-num" style="color: var(--sev-high)">{{ stats.high }}</span>
                        <span class="risk-lbl">High</span>
                    </div>
                    <div class="risk-tile">
                        <span class="risk-num" style="color: var(--sev-medium)">{{ stats.medium }}</span>
                        <span class="risk-lbl">Medium</span>
                    </div>
                    <div class="risk-tile">
                        <span class="risk-num" style="color: var(--sev-low)">{{ stats.low }}</span>
                        <span class="risk-lbl">Low</span>
                    </div>
                </div>
                <div class="risk-bar">
                    <div style="flex: {{ stats.critical }}; background: var(--sev-critical);"></div>
                    <div style="flex: {{ stats.high }}; background: var(--sev-high);"></div>
                    <div style="flex: {{ stats.medium }}; background: var(--sev-medium);"></div>
                    <div style="flex: {{ stats.low }}; background: var(--sev-low);"></div>
                    {% if findings|length == 0 %}<div style="flex: 1; background: #e2e8f0;"></div>{% endif %}
                </div>
            </div>
        </div>
        <div class="markdown-body">{{ report.executive_summary | safe }}</div>
    </div>

    <div class="content-wrapper">
        <h2 class="section-title">2. Detailed Findings</h2>

        {% for finding in findings %}
        <div class="finding-card">
            <div class="finding-header header-{{ finding.severity | upper }}">
                <div class="finding-title">{{ finding.title }}</div>
                <div style="font-family: 'JetBrains Mono'; font-size: 9pt;">ID: {{ finding.finding_id }}</div>
            </div>
            <div class="card-body">
                <span class="field-label">Description</span>
                <div class="markdown-body">{{ finding.description_html | safe }}</div>
                
                {% if finding.cvss %}
                <div style="margin-top: 15px; background: #f8fafc; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; display: inline-block;">
                    <span style="font-weight: 700; font-size: 8pt; color: var(--slate); margin-right: 8px;">CVSS VECTOR</span>
                    <span style="font-family: 'JetBrains Mono'; font-size: 9pt;">{{ finding.cvss }}</span>
                </div>
                {% endif %}

                {% if finding.remediation_html %}
                    <span class="field-label" style="color: var(--primary);">Remediation</span>
                    <div class="markdown-body">{{ finding.remediation_html | safe }}</div>
                {% endif %}
                
                {% if finding.evidence_items %}
                    <span class="field-label">Evidence</span>
                    <div class="evidence-grid">
                        {% for item in finding.evidence_items %}
                            <div class="evidence-item">
                                {% if item.url %}<img src="{{ item.url }}">{% endif %}
                                <div class="evidence-caption">{{ item.caption }}</div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="page-footer">
        <div>{{ client.name }}</div>
        <div>Confidential // Do Not Distribute</div>
        <div>Atomik Security</div>
    </div>

</body>
</html>
